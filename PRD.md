# 📄 产品需求文档 (PRD)

| **项目名称** | **Infinite Canvas AI Workspace (ICAW)** |
| ------------ | --------------------------------------- |
| **版本号**   | v1.0.0 (MVP)                            |
| **文档状态** | 🔴 待评审 / 🟢 **进行中**                 |
| **最后更新** | 2026-02-04                              |
| **负责人**   | [kogorou]                              |

------

## 1. 项目背景与愿景 (Background & Vision)

### 1.1 背景

当前的协作白板市场（如 Miro, Excalidraw）虽然成熟，但在**深度 AI 集成**与**极致的本地优先 (Local-First)** 体验上仍有缺口。本项目旨在构建下一代**智能协作白板**，利用 AI Agent 辅助图形生成与逻辑梳理，同时通过 CRDT 算法保证在弱网/离线环境下的极致可用性。

### 1.2 核心目标 (Goals)

1. **技术展示**：验证高性能渲染引擎（自研 Viewport/SceneGraph）、分布式状态同步（CRDT）与 AI 工程化落地的结合。
2. **业务闭环**：实现从“访客 -> 注册用户 -> 付费订阅 -> 团队协作”的完整 SaaS 业务链路。
3. **性能指标**：支持单画板 **10,000+** 图元流畅交互（60FPS），多端协作延迟 < 100ms。

------

## 2. 核心功能模块 (Functional Requirements)

### 2.1 模块一：高性能渲染引擎 (Core Engine)

> **优先级：P0 (最高)**
>
> *技术关键词：Canvas API, Affine Transform, Dirty Rect, Spatial Index*

| **ID**   | **功能名称**     | **详细描述 (User Story)**                                    | **验收标准 (Acceptance Criteria)**                           |
| -------- | ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **R-01** | **无限视口漫游** | 用户可以通过拖拽（Pan）和滚轮（Zoom）在无限大的画布上自由移动。 | 1. 缩放以鼠标为中心。 2. 缩放范围 10% - 500%。 3. 坐标转换准确无漂移。 |
| **R-02** | **基础图元绘制** | 支持矩形、圆形、文本、连接线四种基础图元。                   | 1. 图元支持选中、拖拽移动。 2. 连接线能自动吸附到图形锚点。  |
| **R-03** | **性能优化模式** | 当图元数量巨大时，自动开启性能保护策略。                     | 1. 视口外图元不渲染 (Culling)。 2. 缩放小于 20% 时，文本自动简化为色块 (LOD)。 |

### 2.2 模块二：实时协作网络 (Collaboration Network)

> **优先级：P0**
>
> *技术关键词：CRDT (Yjs), WebSocket, Offline-First*

| **ID**   | **功能名称**     | **详细描述 (User Story)**                          | **验收标准 (Acceptance Criteria)**                           |
| -------- | ---------------- | -------------------------------------------------- | ------------------------------------------------------------ |
| **C-01** | **多人并发编辑** | 多名用户进入同一画板，可同时修改不同或同一个图元。 | 1. 最终一致性：所有端看到的结果必须一致。 2. 无锁设计：不阻塞用户操作。 |
| **C-02** | **协同感知**     | 显示其他用户的鼠标位置和选中状态。                 | 1. 鼠标移动平滑（含插值动画）。 2. 显示用户昵称 Tag。        |
| **C-03** | **离线支持**     | 断网状态下可继续编辑，重连后自动同步。             | 1. 数据写入 IndexedDB。 2. 重连后自动 Merge 差异，无冲突报错。 |

### 2.3 模块三：AI 智能体 (AI Agent)

> **优先级：P1**
>
> *技术关键词：LLM, Function Calling, Streaming, Prompt Engineering*

| **ID**   | **功能名称**        | **详细描述 (User Story)**                                    | **验收标准 (Acceptance Criteria)**                           |
| -------- | ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **A-01** | **Text-to-Diagram** | 输入自然语言（如“画一个电商下单流程”），AI 自动生成结构化图形。 | 1. AI 返回 JSON 格式的节点/连线数据。 2. 图形自动布局，不重叠。 |
| **A-02** | **智能上下文操作**  | 选中一组卡片，点击“AI 总结”或“AI 润色”。                     | 1. AI 能读取选中节点的文本内容作为 Context。 2. 生成结果以新卡片形式出现在旁边。 |
| **A-03** | **流式响应**        | AI 生成的内容需要像打字机一样逐字显示在 Canvas 上。          | 1. 减少用户等待焦虑。 2. 支持中途取消生成。                  |

### 2.4 模块四：权限与业务系统 (Business & Admin)

> **优先级：P2**
>
> *技术关键词：NestJS, RBAC, JWT, Stripe*

| **ID**   | **功能名称**          | **详细描述 (User Story)**                                    | **验收标准 (Acceptance Criteria)**                           |
| -------- | --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **B-01** | **工作区管理**        | 用户可以创建团队（Workspace），并邀请成员。                  | 1. 支持邮箱邀请链接。                                        |
| **B-02** | **细粒度权限 (RBAC)** | 设置成员角色：Owner（所有者）、Editor（编辑）、Viewer（只读）。 | 1. Viewer 无法触发写入操作。 2. 后端接口/WS 消息需进行权限拦截。 |
| **B-03** | **配额限制**          | 限制免费用户的画板数量和 AI Token 使用量。                   | 1. 超额后弹窗提示升级。                                      |

------

## 3. 非功能性需求 (Technical Constraints)

1. **渲染性能**：
   - FPS >= 55 (在 M1 MacBook Air 上，5000 个节点场景下)。
   - 初始化加载时间 < 1.5秒。
2. **网络延迟**：
   - WebSocket 广播延迟 < 100ms (在良好的 4G/WiFi 环境下)。
   - AI 响应首字延迟 (TTFT) < 2秒。
3. **兼容性**：
   - 支持 Chrome 90+, Safari 14+, Edge。
   - 暂不适配移动端 Touch 事件（MVP 阶段仅限桌面端）。
4. **工程规范**：
   - **Monorepo** 架构 (pnpm workspace)。
   - **TypeScript** 严格模式 (Strict Mode)。
   - 提交代码需通过 ESLint 和 Prettier 检查。

------

## 4. 开发里程碑 (Roadmap)

为了确保项目不烂尾，我们将开发分为三个阶段：

### 🏁 Phase 1: 单机引擎核心 (Week 1-2)

- **目标**：跑通一个“像 Excalidraw 一样流畅的”本地画板。
- **产出**：
  - [ ] 搭建 React + Canvas 基础架构。
  - [ ] 实现视口变换（平移/缩放）。
  - [ ] 实现矩形/文本的创建与拖拽。
  - [ ] 引入 Zustand 管理本地状态。

### 🚀 Phase 2: 协同与持久化 (Week 3-4)

- **目标**：从单机版变为网络版。
- **产出**：
  - [ ] 接入 Yjs 和 Hocuspocus Server。
  - [ ] 实现多端光标同步。
  - [ ] 接入 IndexedDB 实现离线保存。
  - [ ] 部署到新加坡服务器（Docker）。

### 🤖 Phase 3: AI 与 业务闭环 (Week 5-6)

- **目标**：注入灵魂，接入 AI 能力和权限控制。
- **产出**：
  - [ ] NestJS 后端鉴权接口。
  - [ ] 开发“AI 工具栏” (Function Calling 集成)。
  - [ ] 完善 UI/UX，准备上线 Demo。



根据你提供的文件（特别是 `PRD.md`）和新的需求，我为你修订了文档。

**主要修改点：**

1. **技术栈颗粒度细化**：不仅仅写“NestJS”，而是细化到“NestJS + Prisma + BullMQ + Redis”这种级别。这在 P6+ 简历上非常重要，因为它展示了你对**工业级架构**的选型能力。
2. **国内服务本地化 (Localization)**：
   - **支付**：将 Stripe 替换为 **支付宝沙箱 (Alipay Sandbox)**。
     - *理由*：这是个人开发者在国内模拟真实支付全流程（下单、扫码、回调验签）的最佳方案，完全不需要营业执zb照。
   - **对象存储**：将 AWS S3 替换为 **MinIO (自建)** 或 **阿里云 OSS**。
     - *理由*：MinIO 可以部署在你的新加坡 VPS 上，面试时可以说“我搭建了兼容 S3 协议的私有云存储”，听起来比直接调 API 更硬核。
   - **AI 模型**：明确使用 **DeepSeek**，这是目前国内/国际通用的高性价比选择，且 API 兼容 OpenAI 格式，方便未来切换。

以下是更新后的 **PRD v1.1（技术架构深化与本地化版）**。

------

# 📄 产品需求文档 (PRD) - v1.1 技术架构深化版

| **项目名称** | **KoBoard (Infinite Canvas AI Workspace)** |
| ------------ | ------------------------------------------ |
| **版本号**   | v1.1 (Localized & Enhanced)                |
| **文档状态** | 🟢 **开发中**                               |
| **最后更新** | 2026-02-04                                 |
| **负责人**   | [你的名字]                                 |

------

## 1. 技术架构与选型 (Architecture & Stack)

> 本章节替代原有的简单技术列表，旨在展示全栈架构设计能力。

### 1.1 前端架构 (The Editor)

- **核心框架**: `React` (利用 useOptimistic 实现乐观更新)。
- **构建工具**: `Vite` (配置分包策略 manualChunks 优化首屏加载)。
- **开发语言**: `TypeScript` (开启 strict: true)。
- **状态管理**:
  - **UI 状态**: `Zustand` (轻量级，原子化更新)。
  - **协同状态**: `Yjs` (CRDT 核心算法) + `y-websocket` (网络同步)。
  - **服务端状态**: `TanStack Query` (React Query) 用于管理 REST API 缓存。
- **渲染引擎 (核心亮点)**:
  - **底层**: 原生 HTML5 Canvas API (不依赖 Fabric.js/Konva，展示造轮子能力)。
  - **空间索引**: `RBush` (R-Tree) 或 `QuadTree` 实现高效的视口剔除 (Culling) 和命中检测。
- **UI 组件库**: `TailwindCSS` + `Radix UI` (无头组件库，保证可访问性) + `Shadcn/UI`。

### 1.2 后端架构 (The Server)

- **运行时**: `Node.js 20+` (LTS) 或 `Bun`。
- **应用框架**: `NestJS` (企业级模块化架构)。
- **通信协议**:
  - **HTTP**: 处理鉴权、支付、资源管理。
  - **WebSocket**: 使用 `Socket.io` 或 `uWebSockets.js` 处理高频 Yjs 同步信令。
- **数据库与缓存**:
  - **关系型数据库**: `PostgreSQL` (存储用户信息、画板元数据)。
  - **ORM**: `Prisma` (类型安全的数据库访问)。
  - **缓存/消息**: `Redis` (用于 Session、接口限流、WebSocket Pub/Sub)。
- **异步任务队列**: `BullMQ` (基于 Redis)。
  - *用途*：将耗时的 AI 生成任务（DeepSeek 响应可能较慢）放入队列，防止 HTTP 接口超时。

### 1.3 基础设施与 DevOps (国内/自建友好型)

- **容器化**: `Docker` + `Docker Compose` (MVP 阶段)。
- **反向代理**: `Nginx` (处理 SSL 终结、静态资源缓存)。
- **对象存储 (OSS)**: **MinIO** (自托管的 S3 兼容存储) 或 **阿里云 OSS**。
  - *用途*：存储画板缩略图、用户上传的图片资源。
- **支付网关**: **支付宝沙箱 (Alipay Sandbox)**。
  - *用途*：模拟企业级支付流程（RSA2 验签、异步通知回调），无需营业执照。
- **CI/CD**: `GitHub Actions` (自动构建 Docker 镜像并 SSH 部署到新加坡服务器)。

------

## 2. 核心功能模块 (Functional Requirements)

*(模块一、二、三 保持不变，重点更新模块四的业务实现)*

### 2.4 模块四：业务与权限系统 (Business & Localized Services)

> **优先级：P2**
>
> *技术关键词：NestJS Guards, CASL (RBAC), Alipay SDK, MinIO*

| **ID**   | **功能名称**          | **详细描述 (User Story)**                          | **技术实现规格 (Technical Specs)**                           |
| -------- | --------------------- | -------------------------------------------------- | ------------------------------------------------------------ |
| **B-01** | **RBAC 权限系统**     | 用户创建团队并邀请成员，区分 Owner/Editor/Viewer。 | 1. **核心库**：使用 `CASL` 定义 Ability（能力）。 2. **拦截**：在 NestJS Guard 层和 WebSocket Gateway 层同时拦截 Viewer 的写入操作。 |
| **B-02** | **会员订阅 (支付宝)** | 用户扫码支付订阅 Pro 版，解锁 AI 额度。            | 1. **对接**：接入支付宝沙箱环境。 2. **流程**：前端请求预下单 -> 后端返回 QR Code -> 用户扫码 -> 支付宝回调 Webhook -> 后端验签并更新 DB 状态。 3. **幂等性**：利用 Redis 锁处理重复的回调通知。 |
| **B-03** | **画板快照存储**      | 在仪表盘显示画板的最新缩L略图。                    | 1. **流程**：前端 Canvas `toBlob` -> 上传至 **MinIO** -> 获取 URL 存入 Postgres。 2. **优化**：使用 `Presigned URL` (预签名 URL) 让前端直传 MinIO，减轻后端带宽压力。 |

------

## 3. AI Agent 工作流详解 (DeepSeek 集成)

> 描述 AI 在国内/新加坡网络环境下的工作方式。

1. **触发**：用户选中一个节点，点击“AI 扩写”。
2. **调度**：前端发送请求 -> NestJS 接收 -> **BullMQ (任务队列)**。
3. **执行 (Worker)**：
   - Worker 从队列获取任务。
   - 调用 **DeepSeek-V3 API** (base_url 设置为 DeepSeek 官方或国内代理)。
   - *Prompt 策略*：强制要求返回 JSON 格式 `{ "nodes": [...], "edges": [...] }`。
4. **流式反馈**:
   - Worker 将生成的 Token 通过 **Redis Pub/Sub** 推送给 WebSocket Gateway。
   - Gateway 将数据流式传输给前端，实现“打字机”效果。

这是一个非常棒的决策！将 **DeepSeek 换成 Gemini** 并且增加 **BYOK (Bring Your Own Key)** 模式，对于你的简历来说，其实是一个**架构层面的升级**。

**为什么这是一个“P6+”级别的改动？**

1. **商业模式更灵活**：SaaS 早期通常无法承担巨大的 Token 成本。允许“用户填自己的 Key” (BYOK) 是 Notion、Cursor 等先进工具的通用做法。这展示了你对**成本控制 (FinOps)** 的思考。
2. **安全性挑战**：一旦涉及“存储用户的 API Key”，面试官马上就会问你：“你如何保证我的 Key 不被泄露？”这让你有机会展示 **加密存储 (AES-256)** 和 **密钥管理** 的能力。
3. **Gemini 的优势**：Gemini 1.5 Flash 拥有**极大的上下文窗口 (1M Context)**，非常适合把整个画板的 JSON 数据（几万个节点）丢进去让它分析，这方面比 DeepSeek 更适合“全局理解”。

下面是修改后的 **PRD v1.2 (Gemini + BYOK 版)**，重点更新了 AI 架构和安全性部分。

------

# 📄 产品需求文档 (PRD) - v1.2 (Gemini & BYOK Edition)

| **项目名称** | **KoBoard (Infinite Canvas AI Workspace)** |
| ------------ | ------------------------------------------ |
| **版本号**   | v1.2 (Gemini Integrated)                   |
| **文档状态** | 🟢 **定稿**                                 |
| **最后更新** | 2026-02-04                                 |

------

## 1. 技术架构变更 (Architecture Updates)

### 1.1 AI 基础设施 (The AI Layer)

- **模型供应商**: **Google Gemini** (主要使用 `Gemini 2.5 Flash`，兼顾速度与成本；`Gemini 2.5 Pro` 用于复杂推理)。
- **接入方式 (Hybrid Mode)**:
  1. **平台托管 (SaaS Mode)**: 免费用量内，使用平台预置的 API Key（通过后端 Proxy 转发，隐藏 Key）。
  2. **自带密钥 (BYOK Mode)**: 用户在“设置”中填入自己的 Google API Key，平台将使用该 Key 发起请求，不消耗平台额度，且解除速率限制。
- **SDK**: `Google Generative AI SDK` (Node.js)。

### 1.2 安全架构 (Security Layer)

> **新增模块：密钥保险箱**

- **存储加密**: 用户提供的 API Key **绝不明文存储**。
  - 使用 `AES-256-GCM` 算法加密后存入 PostgreSQL。
  - 加密密钥 (Master Key) 通过环境变量注入，不进代码库。
- **传输加密**: 前端 -> 后端必须强制 HTTPS。
- **前端脱敏**: 接口返回用户 Key 信息时，仅返回掩码（如 `AIzaSy...****`）。

------

## 2. 核心功能模块 (Functional Requirements)

### 2.3 模块三：AI 智能体 (Gemini Powered)

> **优先级：P1**
>
> *技术关键词：Multimodal, Long Context, Key Management*

| **ID**   | **功能名称**        | **详细描述 (User Story)**                                    | **技术实现规格 (Technical Specs)**                           |
| -------- | ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **A-01** | **Gemini 视觉生成** | 输入“画一个包含 Redis 和 MySQL 的后端架构图”，生成结构化图形。 | 1. **Prompt**: 利用 Gemini 的长文本能力，System Prompt 包含详细的 JSON Schema 约束。 2. **Fallback**: 如果 JSON 解析失败，利用 Gemini 的纠错能力自动重试一次。 |
| **A-02** | **全板智能分析**    | “帮我总结这整个画板在讲什么”。                               | 1. **Context**: 将 Canvas 上的所有 Text 节点打包。 2. **优势**: 利用 Gemini 1.5 的 **1M Context Window**，一次性吃掉整个项目文档。 |
| **A-03** | **BYOK 设置面板**   | 用户可在设置页管理自己的 Gemini API Key。                    | 1. **验证**: 用户填入 Key 后，后端立即发起一次轻量请求（如 `listModels`）验证有效性。 2. **存储**: 验证通过后，加密存入 `User_Secrets` 表。 |

------

## 3. AI 调用流程设计 (Sequence Flow)

这是一个非常经典的**策略模式 (Strategy Pattern)** 实现，面试时可以画这个图：

1. **请求发起**: 前端发送 `{ prompt: "...", useOwnKey: true/false }`。
2. **守卫 (Guard)**: 后端检查用户额度。
   - 如果 `useOwnKey === true`: 跳过额度检查，尝试从 DB 读取并解密用户的 Key。
   - 如果 `useOwnKey === false`: 检查用户订阅等级 (Free/Pro)，若额度不足则报错。
3. **模型调用**:
   - 实例化 `GoogleGenerativeAI` client。
   - **关键点**: 如果使用用户 Key，**必须**在沙箱或隔离的上下文执行，防止 Prompt 注入攻击窃取系统 Prompt。
4. **流式响应**: 将 `result.stream` 通过 Server-Sent Events (SSE) 或 WebSocket 推回前端。

